/*
  ModbusRTU ESP8266/ESP32
  Simple slave example

  (c)2019 Alexander Emelianov (a.m.emelianov@gmail.com)
  https://github.com/emelianov/modbus-esp8266

  modified 13 May 2020
  by brainelectronics

  This code is licensed under the BSD New License. See LICENSE.txt for more info.
*/
#include <Arduino.h>
#include <ModbusRTU.h>

#define SLAVE_ID 1

ModbusRTU mb;
bool cb(Modbus::ResultCode event, uint16_t transactionID, void* data){}
uint16_t res[5];

void setup() {
  Serial.begin(9600);
  Serial2.begin(9600, SERIAL_8N1, 16, 17);
  mb.begin(&Serial2, 18);
  mb.master();
  pinMode(18, OUTPUT);
  digitalWrite(18, HIGH);
}

void loop() {
  uint16_t kirimData = random(0, 100);
  for(int i=0; i<=4; i++) {
    if (!mb.slave()) {
      mb.writeHreg(1, i, &kirimData, 1, cb);
    }
  }
  if (!mb.slave()) {
    mb.readHreg(1, 5, res, 5, cb);
    while (mb.slave()){
      mb.task();
    }
    for (int i=0; i<4; i++) {
      Serial.print(res[i]);
    }
    Serial.println();
  }
  yield();
}